# Bulk Excel Upload API for Student Assessment Scores

## Overview

This document describes the bulk Excel upload functionality that allows teachers to download Excel templates containing students and assessment columns, fill in scores, and upload them back to the system. The feature ensures data integrity by encoding subject, term, session, and class information in the template to prevent accidental uploads to wrong contexts.

### Why Class Scoping?

Teachers often teach the same subject to multiple classes (e.g., Mathematics to JSS 2A, JSS 2B, JSS 3A). Class scoping provides several benefits:

- **Focused Templates**: Each template contains only students from one specific class, making score entry more manageable
- **Reduced Errors**: Smaller, focused templates reduce the chance of entering scores for wrong students
- **Better Organization**: Teachers can work on one class at a time, improving workflow efficiency
- **Clear Separation**: Templates are clearly labeled with class information (e.g., "Mathematics-JSS2A-First Term")
- **Authorization Control**: Teachers can only access classes they are assigned to teach

## Key Features

1. **Class-Scoped Template Generation**: Teachers can download Excel templates with:
   - Student information (ID, Name, Student Number) for a specific class only
   - Assessment columns based on school's assessment structure
   - Pre-populated existing scores
   - Data validation for score ranges
   - Protected metadata sheet with context information (subject, term, session, class)
   - **Class Separation**: Teachers teaching multiple classes get separate templates for each class, making score entry more manageable

2. **Secure Upload**: Uploaded files are validated to ensure:
   - They were generated by the system (metadata validation)
   - Teacher has authorization for the subject/term/session/class
   - Data integrity is maintained
   - Scores are within valid ranges

3. **Error Handling**: Comprehensive error reporting with:
   - Individual row-level error tracking
   - Partial success support
   - Detailed error messages for failed entries

## Endpoints

### GET /api/assessments/bulk-upload/debug

**Description**: Debug endpoint to check available data for template generation

**Authentication**: Bearer Token (JWT) required

**Authorization**: Teacher role required

**Response:**
```json
{
  "schoolId": "school-uuid",
  "subjects": ["Mathematics", "English", "Science"],
  "academicSessions": ["2024/2025", "2023/2024"],
  "terms": ["First Term", "Second Term", "Third Term"],
  "levels": ["JSS 1", "JSS 2", "JSS 3"],
  "classArms": ["JSS 1A", "JSS 1B", "JSS 2A", "JSS 2B"],
  "assessmentStructures": [
    {
      "name": "Test 1",
      "maxScore": 20,
      "isExam": false
    },
    {
      "name": "Exam",
      "maxScore": 60,
      "isExam": true
    }
  ]
}
```

### POST /api/assessments/bulk-upload/template

**Description**: Generate Excel template for bulk assessment score upload

**Authentication**: Bearer Token (JWT) required

**Authorization**: Teacher role required

**Request Body:**
```json
{
  "subjectName": "Mathematics",
  "termName": "First Term",
  "sessionName": "2024/2025",
  "levelName": "JSS 2",
  "classArmName": "A"
}
```

**Response**: Excel file (.xlsx) with the following structure:

#### Template Structure

**Metadata Sheet** (Protected):
- Subject: Mathematics
- Term: First Term
- Session: 2024/2025
- Level: JSS 2
- Class Arm: A
- Generated At: 2025-01-15T10:00:00Z
- Generated By: teacher-uuid
- School ID: school-uuid
- Subject Term ID: subject-term-uuid
- Class Arm ID: class-arm-uuid
- Assessment Structures: List of assessment types with max scores
- **Note**: Metadata is stored in multiple hidden cells with invisible text to prevent user manipulation

**Class Sheet** (Named after level and class, e.g., "SS1 C"):
| Bright Future High School |
| First Term 2024/2025 SS1 A Mathematics |
|                              |
| S/N | Student Name | Student Number | Test 1 (Max: 20) | Test 2 (Max: 20) | Exam (Max: 60) |
|-----|--------------|----------------|------------------|------------------|----------------|
| 1   | John Doe     | STU001         | 18               | 19               | 55              |
| 2   | Jane Smith   | STU002         | 20               | 18               | 58              |

**Features**:
- Sheet named after level and class (e.g., "SS1 C") for easy identification
- Context information (school, subject, term, level, class, session) at the top
- Professional styling with increased row heights and consistent 14pt font size
- Merged context cells spanning all columns for centered display (background colors limited to merged area only)
- S/N (Serial Number) column for easy row identification
- Alternating row backgrounds consistently covering content area (A to last column)
- Header background limited to content area only (no extension beyond data)
- All content cells with thin borders for clear structure
- Centered score columns and S/N, left-aligned student names/numbers
- Data validation on score columns (0 to max score)
- Existing scores pre-populated as numbers (Google Sheets compatible)
- Integer number formatting for score columns
- Optimized column widths for better readability (Student Number column widened for full display)
- Multiple hidden cells with invisible text to prevent data manipulation (robust extraction with fallback locations)
- Protected metadata to prevent tampering

### POST /api/assessments/bulk-upload/process

**Description**: Process uploaded Excel file for bulk assessment score upload

**Authentication**: Bearer Token (JWT) required

**Authorization**: Teacher role required - must be assigned to teach the specified subjects

**Request**: Multipart form data with Excel file

**File Requirements**:
- Must be .xlsx or .xls format
- Must be generated using the template endpoint
- Must contain valid metadata sheet

**Response:**
```json
{
  "success": true,
  "message": "Bulk upload completed. 15 successful, 2 failed.",
  "status": 200,
  "data": {
    "success": [
      {
        "studentId": "student-uuid-1",
        "studentName": "John Doe",
        "assessmentName": "Test 1",
        "score": 18,
        "isExam": false
      },
      {
        "studentId": "student-uuid-2",
        "studentName": "Jane Smith",
        "assessmentName": "Test 1",
        "score": 20,
        "isExam": false
      }
    ],
    "failed": [
      {
        "studentId": "student-uuid-3",
        "studentName": "Bob Johnson",
        "assessmentName": "Test 1",
        "score": 25,
        "error": "Score must be between 0 and 20"
      }
    ]
  }
}
```

## Security Features

### Template Security
1. **Metadata Encoding**: Each template contains encoded metadata including:
   - School ID
   - Subject Term ID
   - **Dynamic Hidden Cell Storage**: Metadata stored in cells after the student data (lastRow + 100, 200, 300)
- **Invisible Text**: White text color makes data invisible to users
- **Multiple Backup Locations**: Data stored in 3 different cell locations for redundancy
- **No Hidden Sheets**: Avoids Google Sheets hamburger menu visibility issue
- **No Worksheet Interference**: Metadata stored after data prevents any interference with student data placement
- **Google Sheets Compatible**: File size remains small enough for Google Sheets import
   - Class Arm ID
   - Teacher ID
   - Generation timestamp
   - Assessment structure information

2. **Protected Metadata Sheet**: The metadata sheet is password-protected to prevent tampering

3. **Context Validation**: Upload validation ensures:
   - Template was generated for the correct school
   - Teacher has authorization for the subject/term/session/class
   - Assessment structure matches school's configuration

### Authorization
- Teachers can generate templates for subjects in their school (flexible access)
- Upload validation ensures teacher belongs to the same school as the template
- If specific ClassArmSubjectTeacher records exist, they are validated
- If no specific records exist, teachers with general school access are allowed
- All operations are scoped to the teacher's school

### Data Validation
- Score ranges are validated against assessment structure max scores
- Student numbers are validated against enrolled students
- Assessment names are validated against school's assessment structure (case-insensitive)
- Existing assessment scores are updated, new ones are created
- Soft delete handling ensures only active records are modified
- Subject, term, level, and class arm names are matched case-insensitively
- File format validation (Excel only)
- All students in the class are included in the template, regardless of subject term enrollment

## Error Handling

### Template Generation Errors
- `400 Bad Request`: No assessment structures found for school
- `400 Bad Request`: Teacher does not have access to teach this subject in this class
- `404 Not Found`: Subject term not found
- `404 Not Found`: Class arm not found
- `404 Not Found`: No students found for this subject term in the specified class

### Upload Processing Errors
- `400 Bad Request`: Invalid file format
- `400 Bad Request`: Template is for a different school
- `400 Bad Request`: Teacher does not have access to this subject term and class
- `400 Bad Request`: Invalid template structure

### Individual Row Errors
- Missing student ID or name
- Invalid score format
- Score out of range
- Student not found
- Assessment not found

## Usage Examples

### 1. Generate Template

```bash
curl -X POST /api/assessments/bulk-upload/template \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "subjectName": "Mathematics",
    "termName": "First Term",
    "sessionName": "2024/2025",
    "levelName": "JSS 2",
    "classArmName": "A"
  }' \
  --output mathematics-jss2a-template.xlsx
```

### 2. Upload Filled Template

```bash
curl -X POST /api/assessments/bulk-upload/process \
  -H "Authorization: Bearer <token>" \
  -F "file=@mathematics-jss2a-template.xlsx"
```

### 3. Frontend Integration Example

```javascript
// Generate template
const generateTemplate = async (subjectName, termName, sessionName, levelName, classArmName) => {
  const response = await fetch('/api/assessments/bulk-upload/template', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      subjectName,
      termName,
      sessionName,
      levelName,
      classArmName,
    }),
  });
  
  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `assessment-template-${subjectName}-${levelName}${classArmName}-${termName}.xlsx`;
  a.click();
};

// Upload filled template
const uploadTemplate = async (file) => {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch('/api/assessments/bulk-upload/process', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
    },
    body: formData,
  });
  
  return response.json();
};
```

## Implementation Details

### Files Created/Modified

1. **Services**:
   - `src/components/assessments/services/excel-bulk-upload.service.ts` - Core Excel processing logic

2. **DTOs**:
   - `src/components/assessments/dto/generate-template.dto.ts` - Template generation request
   - `src/components/assessments/dto/bulk-upload-result.dto.ts` - Upload result structure

3. **Results**:
   - `src/components/assessments/results/bulk-upload-result.ts` - API response wrapper

4. **Controller**:
   - `src/components/assessments/assessments.controller.ts` - Added bulk upload endpoints

5. **Service**:
   - `src/components/assessments/assessments.service.ts` - Added bulk upload methods

6. **Module**:
   - `src/components/assessments/assessments.module.ts` - Added Excel service

### Dependencies Used

- **ExcelJS**: For Excel file generation and processing
- **Multer**: For file upload handling
- **Class-validator**: For request validation

### Database Operations

1. **Template Generation**:
   - Fetches assessment structures for school
   - Retrieves subject term information
   - Gets enrolled students with existing scores
   - Validates teacher authorization

2. **Upload Processing**:
   - Validates template metadata
   - Processes each row individually
   - Upserts assessment scores
   - Updates total scores
   - Maintains referential integrity

### Performance Considerations

- Templates are generated on-demand
- Large files are processed row by row to maintain data consistency
- Database operations are optimized with proper indexing
- File size limits should be considered for very large classes

## Integration with Existing Features

- **Assessment Structures**: Templates are generated based on school's assessment structure
- **Student Management**: Only enrolled students appear in templates
- **Authorization**: Reuses existing teacher-subject-class assignment validation
- **Activity Logging**: All operations are logged for audit purposes
- **Grading Models**: Total scores are updated for grade calculation

## Best Practices

1. **Template Usage**:
   - Always use the generated template
   - Don't modify the metadata sheet
   - Keep student IDs unchanged
   - Use only the provided assessment columns

2. **Data Entry**:
   - Enter scores only in the designated columns
   - Use numeric values only
   - Leave empty cells for students without scores
   - Don't modify column headers

3. **Error Handling**:
   - Review failed entries before re-uploading
   - Fix data issues in the Excel file
   - Re-upload only after addressing all errors

4. **Security**:
   - Don't share templates between schools
   - Use only authorized templates
   - Report any suspicious template modifications

## Troubleshooting

### Debugging Steps

1. **Use the Debug Endpoint**: First, call `GET /api/assessments/bulk-upload/debug` to see what data is available in your school
2. **Check Available Data**: Verify that the subject, term, session, level, and class arm you're trying to use exist
3. **Verify Teacher Assignment**: Ensure the teacher is assigned to teach the subject in the specific class

### Common Issues

1. **Template Generation Fails**:
   - **"Academic session not found"**: Check available sessions using debug endpoint
   - **"Subject not found"**: Verify subject name exists (case-insensitive matching)
   - **"Term not found"**: Ensure term exists for the specified academic session
   - **"Level not found"**: Check available levels using debug endpoint
   - **"Class arm not found"**: Verify class arm exists for the specified level
   - **"Subject term not found"**: Subject may not be offered in that term/session
   - **"Teacher does not have access"**: Teacher not assigned to teach this subject in this class
   - **"No students found"**: Students may not be enrolled in the subject term

2. **Upload Fails**:
   - Verify file is Excel format
   - Check template was generated by the system
   - Ensure teacher has authorization
   - Verify student numbers match existing students

3. **Partial Upload Success**:
   - Review failed entries in response
   - Fix data issues in Excel file
   - Re-upload corrected file

### Error Messages

- **"Academic session 'X' not found. Available sessions: Y, Z"** - Use one of the available sessions
- **"Subject 'X' not found. Available subjects: Y, Z"** - Use one of the available subjects
- **"Term 'X' not found for session 'Y'. Available terms: Z"** - Use one of the available terms
- **"Level 'X' not found. Available levels: Y, Z"** - Use one of the available levels
- **"Class arm 'X' not found for level 'Y'. Available class arms: Z"** - Use one of the available class arms
- **"Subject term not found. Subject 'X' may not be offered in term 'Y' for session 'Z'"** - Subject not offered in that combination
- **"Teacher does not have access to teach 'X' in Y. Available subjects: Z"** - Teacher not assigned to this subject/class
- **"No students found in X"** - No students in the class
- **"No students found enrolled in 'X' for Y in Z. Students exist in the class but may not be enrolled in this subject term"** - Students not enrolled in subject term

## Future Enhancements

1. **Batch Processing**: Support for processing multiple files
2. **Progress Tracking**: Real-time upload progress for large files
3. **Template Customization**: Allow teachers to customize template columns
4. **Historical Tracking**: Track template generation and upload history
5. **Advanced Validation**: More sophisticated data validation rules
6. **Export Features**: Export upload results to Excel for review
